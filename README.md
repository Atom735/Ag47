# Рабочий проект

## Имспользуемые средства

[msys2](https://www.msys2.org/)

Библиотеки:
* libarchive
* libxml2

```bash
  pacman -S \
  mingw-w64-x86_64-gcc \
  mingw-w64-x86_64-gdb \
  mingw-w64-x86_64-make \
  mingw-w64-x86_64-libarchive \
  mingw-w64-x86_64-libxml2 \
  mingw-w64-x86_64-pcre2 \

```

Кароч, качаешь msys2, ставишь его, запускаешь внутри `mingw64.exe`.
След шагом в консоль mingw64 вводим команды для установки пакетов.
Для перестройки проекта перейти в папку с проектом, используя команду `cd`.
Находясь в папке проекта запукстить `mingw32-make`.
Для удобства просмотра и написания кода, советую пользоваться [Sublime Text Editor 3](https://www.sublimetext.com/)

## Файлы кода

Весь код хранится в папке `src`.
Программа состоит из одного объекта.

- __ag47_misc.c__
  Код общих функций обработки строк и указателей в файле
- __ag47_parse.c__
  Код оболочки парсинга дерева, и отбора файлов на парсинг. Проверка сигнатуры файла и отправка его обработки в другие парсеры происходит здесь.
- __ag47_parse_docx.c__
  Код парсинга только _docx_ файлов с инклинометрией (_doc_ файлы преобразуются программой `wordconv.exe`)
- __ag47_parse_las.c__
  Код парсинга _las_ файлов ГИС
- __ag47_parse_txt.c__
  Парсинг _txt_ файлов с инклинометрией
- __ag47_settings.c__
  Парсинг файла скрипта, и запуск обработки
- __ag47_settings.h__
  Все переменные кодов ошибок, а также структура сценариев
- __ag47_tbl_map_*.x__
  Файлы отображений символов из одной кодировки в Unicode
- __ag47_tbl_rus_a.x__
  Частота встречаемости русских букв в тексте
- __ag47_tbl_rus_b.x__
  Частота встречаемости русских пар букв в тексте
- __main.c__
  Самый главный файл, также точка входа в программу
- __ag47_arrays.c__
  Функции по работе со динамичными массивами (векторами) с разными типами наполнения, также функции сравнения и обработки строк (как векторов)
- __ag47_dbf.c__
  Парсинг _dbf_ файлов и изъятие нужных данных
- __ag47_fs.c__
  Работа с файловой системой, отображение файлов в память.
- __ag47_log.c__
  Фукнции логирования (записи отладочной информации в память)
- __ag47_map.c__
  Код связанный с кодировками
- __ag47_maps.x__
  Шаблон для кодировок и их отображений
- __ag47_maps_names.x__
  Шаблон для имён кодировок и их ID


## Файл сценария

Расширение файла __\*.ag47-script__

Файл начинается с заголовка, первый символ либо [BOM](https://ru.wikipedia.org/wiki/Маркер_последовательности_байтов),
либо `#` после которого указывается кодировка файла (прим. `#UTF-8`, `#.1251`).
Номера кодовых страниц можно найти на сайте [msdn](https://docs.microsoft.com/ru-ru/windows/win32/intl/code-page-identifiers)
Если не указано, парсер сам попытается угадать кодировку.

| ID Кодировки | Сокращённое название              | Полное название                          |
| ------------:| --------------------------------- | ---------------------------------------- |
| 855          | IBM855                            | OEM Cyrillic (primarily Russian)         |
| 866          | cp866                             | OEM Russian; Cyrillic (DOS)              |
| 1251         | windows-1251                      | ANSI Cyrillic; Cyrillic (Windows)        |
| 10007        | x-mac-cyrillic                    | Cyrillic (Mac)                           |
| 20866        | koi8-r                            | Russian (KOI8-R); Cyrillic (KOI8-R)      |
| 28595        | iso-8859-5                        | ISO 8859-5 Cyrillic                      |
| 1200         | utf-16                            | Unicode UTF-16, little endian byte order |
| 1201         | unicodeFFFE                       | Unicode UTF-16, big endian byte order    |
| 12000        | utf-32                            | Unicode UTF-32, little endian byte order |
| 12001        | utf-32BE                          | Unicode UTF-32, big endian byte order    |
| 65001        | utf-8                             | Unicode (UTF-8)                          |

### Общие сведения

* `//` - комментарий до конца строки
* `/*...*/` - блок комментарий

### Параметры сценария

Общая строка параметра выглядит как `ws name ws = ws value ws ;` где вместо `value` может быть следующие типы данных:
- __ARRAY OF VALUE__: `[ ws value ws , ... ]`
- __STRING__: `'{{RAW_DATA}}'`
- __CSTRING__: `"{{cstring}}"`
- __NUMBER__: `{{INT}}`
_ __BOOL__: `TRUE` или `FALSE`

По умолчанию открывается файл `.ag47-script`
Файл без строки `RUN` записывает в `.ag47.log` допустимые настройки

__Больше информации можно найти в комментариях файла с кодом__ `ag47_settings.h`

# Всё что ниже, не реализовано

* [ ] in
  массив всех папок, файлов, которые необходимо обработать

* [ ] out
  папка куда будут сохраняться конечные данные

# Остальное не нуждается в реализации в данный момент


* [ ] `RUN=["."];` -
  путь к поиску файлов, начинает поиск и обработку используя все
  предыдущие настройки.

* [ ] `RESET;` -
  сбрось настроек к настройкам по умолчанию.

* [ ] `OUT_PATH=".ag47";` -
  указывает папку для сохранения файлов и отладочных данных, если папки не
  существует, то она будет создана.

* [ ] `OUT_RECREATE=FALSE;` -
  если указан `TRUE`, то папка будет пересоздана, т.е. внутри папки {{PATH_OUT}} всё почистится.

* [ ] `LAS_FORMAT=[".las",".las[0]",".las[1]"];` -
  указывает окончание для поиска _LAS_ файлов.

* [ ] `LAS_UPDATE=FALSE;` -
  разрешить модифицировать исходящие `LAS` файлы.

* [ ] `LAS_EOL=NULL;` -
  указвает конец строки для модифицированного файла, может принимать значения:
  `CR`, `LF`, `CRLF`,
  `NULL` - не изменять.

* [ ] `LAS_CP=".1251";` -
  указвает конечную кодировку для модифицированного файла, может принимать значения:
  `NULL` - не изменять.
  (другие значения в таблице кодировок)

| ID Кодировки | Сокращённое название              | Полное название                       |
| ------------:| --------------------------------- | ------------------------------------- |
| 855          | IBM855                            | OEM Cyrillic (primarily Russian)      |
| 866          | cp866                             | OEM Russian; Cyrillic (DOS)           |
| 1251         | windows-1251                      | ANSI Cyrillic; Cyrillic (Windows)     |
| 10007        | x-mac-cyrillic                    | Cyrillic (Mac)                        |
| 20866        | koi8-r                            | Russian (KOI8-R); Cyrillic (KOI8-R)   |
| 21866        | koi8-u                            | Ukrainian (KOI8-U); Cyrillic (KOI8-U) |
| 28595        | iso-8859-5                        | ISO 8859-5 Cyrillic                   |

* [ ] `LAS_LOG_DATA_PATH=".logs/las.log";` -
  путь к потсроению таблицы всех данных `LAS` файлов, если указать
  `LOG_LAS_DATA=NULL;`, то данные не будут сохранятся.

* [ ] `LAS_LOG_DATA_HEAD_FMT=["%(SECTION)|"];` -
  какие общие данне LAS файла будут записаны в таблицу всех данных `LAS` файлов.
* [ ] `LAS_LOG_DATA_LINE_FMT="%(SECTION)|";` -
  какие данне о каждой линии будут записаны в таблицу всех данных `LAS` файлов.

| Имя переменной FMT    | Описание                          | Пример вывода                         |
| --------------------- | --------------------------------- | ------------------------------------- |
| [x] `CODEPAGE_ID`     | Номер кодировки                   | `1251`                                |
| [x] `CODEPAGE`        | Сокращённое название кодировки    | `windows-1251`                        |
| [x] `CODEPAGE_FULL`   | Полное название кодировки         | `ANSI Cyrillic; Cyrillic (Windows)`   |
| [x] `CODEPAGE_A1`     | Количество очков кодировки        | `20594414`                            |
| [x] `CODEPAGE_A2`     | Количество очков кодировки        | `11217259`                            |
| [x] `CODEPAGES`       | Пройтись по всем кодировкам       | ---                                   |
| [x] `ENDOFLINE`       | Символ конца строки               | `CRLF`                                |
| [x] `ENDOFLINE_EX`    | Символ конца строки расширенное   | `CRLF (Windows)`                      |
| [x] `ORIGIN_PATH`     | Путь к оригиналу файла            | `F:\LAS\BK1.LAS`                      |
| [x] `NLINE`           | Номер строки                      | `13`                                  |
| [x] `SECTION`         | Символ секции                     | `V`                                   |
| [x] `SECTION_FULL`    | Полная стркоа секции              | `Version information`                 |
| [x] `S_MNEM`          | Мнемоника                         | `DFD`                                 |
| [x] `S_UNIT`          | Размерность                       | `K/M3`                                |
| [x] `S_DATA`          | Данные                            | `1200.0000`                           |
| [x] `S_DESC`          | Описание                          | `Mud Weight`                          |


* [ ] `INK_FORMAT=[".doc",".docx",".txt"];` -
  указывает окончания для поиска файлов с инклинометрией

* [ ] `ARCHIVES_FORMAT=[".zip",".rar"];` -
  формат файлов архивов в которых будет производится поиск




## Задачи



Техническое задание
на создание программы для анализа и подготовки данных ГИС и инклинометрии скважин.

По работе с LAS-файлами

1.	Программа должна проходить по папкам, подпапкам, архивам данных и находить  файлы формата LAS. Программа должна читать все три формата LAS - 1.2, 2.0 и 3.0. Описание форматов можно увидеть
https://kpfu.ru/docs/F2101427612/Uchebnoe..posobie.Standart.hraneniya.dannyh.karotazha.LAS_versii.1_2.i.2_0_.pdf
http://www.cwls.org/las/
2.	Сформировать по результатам поиска выходную экселевскую таблицу по методам ГИС (логам) (пример 1)
a)	В таблицу должно записываться значение глубины начала и конца лога (метода ГИС). Глубина в las-файле всегда идет в первой колонке. В шапке файла описывается как DEPT. В расчет не должны входить значения NULL.  Используемое в файле значение NULL прописывается в шапке файла в строке NULL.

b)	Номера скважин необходимо брать из шапки Las-файла, если он конечно там прописан. Номер скважины указывается в строке WELL. Если в шапке las-файла не указан номер скважины, то его можно вытащить из названия папки; либо названия файла, если там указан номер; либо названия других файлов (инклинометры или заключения по ГИС).


c)	Названия методов ГИС брать из шапки Las-файла
d)	В одной и той же скважине может быть один и тот же метод ГИС, но в разных глубинах. Все имеющиеся ласы должны быть указаны.
e)	В одном las-файле может быть много логов (методов ГИС). Названия методов ГИС прописывается в шапке las-файла.

f)	Дополнительную информацию по видам las-файлов можно найти в инете. Это общепризнанный формат для хранения информации ГИС.
3.	Все las-файлы распределены по папкам, подпапкам и архивам zip и rar. Нам для пакетной загрузки необходимо все закинуть в одну папку по всем скважинам. Название файла должно формироваться следующим образом: номер_скважины_предыдущее_название_файла.las. В случае если появляются дубликаты названий в конце добавлять порядковый номер файла _1, _2 и т.д. Пример в папке «Пример названия ласов в единой папке».
4.	Если выявляются дубликаты las-файлов  по скважинам, то в папку для загрузки должен быть выгружен только один файл. Но необходимо какое-то правило, чтобы признавать файл дубликатом. Например, в 90% случаев значения лога в одинаковых точках глубин совпадает в двух разных las-файлах.

По работе с инклинометрией
1.	Так же по всем папкам, подпапкам, архивам надо найти файлы с инклинометрией.
2.	Наличие инклинометрии также необходимо указывать в таблице (пример 1). Необходимо указать значения глубины начала и конца инклинометрии.
Есть много вариантов хранения инклинометрии – стандартный формат инклинометрии, которые идут от подрядчика по ГИС, и выгрузки из баз данных.
3.	Стандартный формат представлен в файле «Пример инклинометра_1240_1_239», в котором нас интересуют только данные, выделенные желтым.

4.	Значение альтитуды сразу должно записываться в таблицу (пример 1).
5.	Из номера скважины, Угла склонения и трех колонок Глубина, Угол и Азимут должны формироваться файлы для загрузки инклинометрии по каждой скважине (пример_готового_инклинометра). При этом к Азимуту должен быть прибавлен Угол склонения.  Но есть два варианта исходных инклинометров:
a)	Запись углов и азимутов сделана в минутах, как показано на примере

Тогда алгоритм действий следующий: 1- пересчитать минуты (часть после запятой) в доли (у колонки Угол, Азимут и у Угла склонения). 2- прибавить угол склонения к Азимуту, 3 – сформировать файл для загрузки.
b)	Запись углов и азимутов сделана в долях. Тогда в файле пишут град’град, как показано на примере

Тогда не надо пересчитывать значения после запятой в доли и сразу делать по алгоритму: 2- прибавить угол склонения к Азимуту, 3 – сформировать файл для загрузки.
6.	Все готовые файлы должны быть собраны в одной папке. Файл называть по номеру скважины, если есть несколько вариантов по одной скважине, то прибавляем _1, _2 и т.д. Но может быть несколько стволов в одной скважине. Если у каждого ствола свое название, то берем его, если нет названия, то просто прибавляем _1, _2. Дальше уже специалист разберется.

7.	Есть данные, которые изначально были выгружены из базы данных (есть пример).



8.	В данном случае все скважины загружены в один файл. Необходимо просто нарезать и сделать для каждой скважины свой файл.
9.	В данном случае надо брать колонки GLUB, UGOL1 (так как он уже в долях) и AZIMUT (а азимут без значений после запятой идет), а номер скважины из колонки NSKV. Но не всегда именно такой файл, поэтому может предусмотреть создание формата чтения файла?
10.	PDF  в формате картинки мы будем набивать в ручную.
11.	Файлы с инклинометрией в формате txt по структуре очень похожи на файлы в формате Word, их надо прочитывать.
12.	Для распознавания файлов с инклинометрией надо смотреть сам файл, потому что они могут называться совершенно по-разному.  Но обычно всегда указан номер скважины в названии (чаще всего).


На данном этапе все остальные файлы игнорим.
